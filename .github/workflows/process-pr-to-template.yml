name: Process PR to Template Branch

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - Template

permissions:
  contents: write
  pull-requests: write

jobs:
  process-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Template branch
        uses: actions/checkout@v4
        with:
          ref: Template
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Generate branch name with timestamp
        id: branch-name
        run: |
          # Format: ddmmyy_hhmm
          BRANCH_NAME=$(date -u +"%d%m%y_%H%M")
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME"
      
      - name: Create new branch from Template
        run: |
          git checkout -b ${{ steps.branch-name.outputs.branch_name }}
      
      - name: Fetch PR changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PR number and head repository
          PR_NUMBER=${{ github.event.pull_request.number }}
          HEAD_REPO=${{ github.event.pull_request.head.repo.full_name }}
          HEAD_REF=${{ github.event.pull_request.head.ref }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "PR Number: $PR_NUMBER"
          echo "Head Repo: $HEAD_REPO"
          echo "Head Ref: $HEAD_REF"
          echo "Head SHA: $HEAD_SHA"
          
          # If it's from a fork, add the fork as a remote
          if [ "$HEAD_REPO" != "${{ github.repository }}" ]; then
            echo "PR is from a fork, adding remote"
            git remote add fork https://github.com/$HEAD_REPO.git
            git fetch fork $HEAD_REF
            git checkout -b pr-$PR_NUMBER fork/$HEAD_REF
          else
            echo "PR is from same repository"
            git fetch origin pull/$PR_NUMBER/head:pr-$PR_NUMBER
            git checkout pr-$PR_NUMBER
          fi
      
      - name: Copy modified files to Submissions folder
        run: |
          # Get the list of changed files in the PR
          git diff --name-only origin/Template...HEAD > changed_files.txt
          
          echo "Changed files:"
          cat changed_files.txt
          
          # Checkout back to our new branch
          git checkout ${{ steps.branch-name.outputs.branch_name }}
          
          # Ensure Submissions directory exists
          mkdir -p Submissions
          
          # Copy each changed file to Submissions folder
          while IFS= read -r file; do
            # Check if file exists in pr branch
            if git cat-file -e pr-${{ github.event.pull_request.number }}:"$file" 2>/dev/null; then
              echo "Copying $file to Submissions/"
              # Get just the filename without path
              filename=$(basename "$file")
              # Copy from pr branch
              git show pr-${{ github.event.pull_request.number }}:"$file" > "Submissions/$filename"
            fi
          done < changed_files.txt
      
      - name: Commit changes
        run: |
          git add Submissions/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add submissions from PR #${{ github.event.pull_request.number }}"
            git push origin ${{ steps.branch-name.outputs.branch_name }}
            echo "Changes committed and pushed"
          fi
      
      - name: Close Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Close the PR with a comment
          gh pr close ${{ github.event.pull_request.number }} \
            --comment "Automated processing complete. Files have been copied to the Submissions folder in branch ${{ steps.branch-name.outputs.branch_name }}. This PR is now closed." \
            --repo ${{ github.repository }}

name: PR to Working Folder

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master

jobs:
  copy-to-working-folder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get modified files from PR
        id: get-files
        run: |
          # Get the base branch
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Comparing $BASE_SHA...$HEAD_SHA"
          
          # Get list of modified files (added, modified, renamed)
          git diff --name-only --diff-filter=AMR "$BASE_SHA" "$HEAD_SHA" > /tmp/modified_files.txt
          
          echo "Modified files:"
          cat /tmp/modified_files.txt
          
          # Count files
          FILE_COUNT=$(wc -l < /tmp/modified_files.txt)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Copy files to Working Folder
        run: |
          # Create Working Folder if it doesn't exist
          mkdir -p "Working Folder"
          
          # Read the list of modified files
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Get just the filename
              filename=$(basename "$file")
              
              # Copy to Working Folder
              echo "Copying $file to Working Folder/$filename"
              cp "$file" "Working Folder/$filename"
            fi
          done < /tmp/modified_files.txt
      
      - name: Commit and push changes
        run: |
          # Check if there are any changes in Working Folder
          if git diff --quiet "Working Folder/"; then
            echo "No changes to commit"
          else
            git add "Working Folder/"
            git commit -m "Auto-copy PR #${{ github.event.pull_request.number }} files to Working Folder"
            git push origin ${{ github.event.pull_request.head.ref }}
            echo "Changes committed and pushed"
          fi
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fileCount = '${{ steps.get-files.outputs.file_count }}';
            if (fileCount > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âœ… Automated workflow completed: ${fileCount} file(s) have been copied to the Working Folder.`
              });
            }

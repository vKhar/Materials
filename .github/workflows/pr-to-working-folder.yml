name: PR to Working Folder

# Using pull_request_target instead of pull_request to avoid requiring manual approval
# for workflows triggered by PRs from forked repositories. This is safe because:
# 1. The workflow doesn't execute any code from the PR
# 2. All file paths are validated against path traversal attacks
# 3. Files are fetched using specific commit SHAs from git objects
# 4. No arbitrary code execution occurs
on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
      - 2026_Jan

jobs:
  copy-to-working-folder:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get modified files from PR
        id: get-files
        run: |
          # Get the base and head information
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          
          echo "Comparing $BASE_SHA...$HEAD_SHA"
          echo "Head repository: $HEAD_REPO"
          echo "Head ref: $HEAD_REF"
          
          # Validate repository name format (owner/repo) - GitHub allows letters, numbers, hyphens, and underscores
          if ! echo "$HEAD_REPO" | grep -qE '^[a-zA-Z0-9_-]+/[a-zA-Z0-9_-]+$'; then
            echo "Error: Invalid repository name format"
            exit 1
          fi
          
          # Fetch the PR head from the source repository (fork or same repo)
          if [ "$HEAD_REPO" != "${{ github.repository }}" ]; then
            # For forks, use git remote add for better security
            git remote add pr-source "https://github.com/$HEAD_REPO.git"
            git fetch --depth=1 --no-tags pr-source "$HEAD_REF:pr-${{ github.event.pull_request.number }}"
            git remote remove pr-source
          else
            # For same repository, fetch from origin
            git fetch --depth=1 --no-tags origin "$HEAD_REF:pr-${{ github.event.pull_request.number }}"
          fi
          
          # Get list of modified files (added, modified, renamed)
          git diff --name-only --diff-filter=AMR "$BASE_SHA" "$HEAD_SHA" > /tmp/modified_files.txt || true
          
          echo "Modified files:"
          cat /tmp/modified_files.txt || echo "No files modified"
          
          # Count files
          FILE_COUNT=$(wc -l < /tmp/modified_files.txt | tr -d ' ')
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Copy files to Working Folder
        run: |
          # Create Working Folder if it doesn't exist
          mkdir -p "Working Folder"
          
          # Check if file list exists and is not empty
          if [ ! -s /tmp/modified_files.txt ]; then
            echo "No files to copy"
            exit 0
          fi
          
          # Read the list of modified files
          while IFS= read -r file; do
            # Comprehensive path validation to prevent path traversal and other attacks
            # Check for: absolute paths, parent directory references, null bytes, control characters
            if echo "$file" | grep -qE '(^/|^\.\./|/\.\./|^\.\.$|/\.\.$|[\x00-\x1F\x7F])'; then
              echo "Warning: Skipping potentially unsafe file path: $file"
              continue
            fi
            
            # Check if the file exists in the PR head commit
            if git cat-file -e "${{ github.event.pull_request.head.sha }}:$file" 2>/dev/null; then
              # Get just the filename
              filename=$(basename "$file")
              
              # Additional validation for filename
              if [ -z "$filename" ] || [ "$filename" = "." ] || [ "$filename" = ".." ]; then
                echo "Warning: Invalid filename, skipping: $file"
                continue
              fi
              
              # Check if file already exists in Working Folder
              if [ -f "Working Folder/$filename" ]; then
                echo "Warning: Working Folder/$filename already exists, will be overwritten"
              fi
              
              # Copy from PR head to Working Folder (using cat to preserve binary files)
              echo "Copying $file to Working Folder/$filename"
              git show "${{ github.event.pull_request.head.sha }}:$file" | cat > "Working Folder/$filename"
            else
              echo "Warning: $file not found in PR head commit"
            fi
          done < /tmp/modified_files.txt
      
      - name: Commit and push changes
        run: |
          # Check if there are any changes in Working Folder
          if git diff --quiet "Working Folder/"; then
            echo "No changes to commit"
          else
            git add "Working Folder/"
            git commit -m "Auto-copy PR #${{ github.event.pull_request.number }} files to Working Folder"
            git push origin ${{ github.event.pull_request.base.ref }}
            echo "Changes committed and pushed to ${{ github.event.pull_request.base.ref }}"
          fi
      
      - name: Comment on PR
        continue-on-error: true
        uses: actions/github-script@v6
        with:
          script: |
            const fileCount = parseInt('${{ steps.get-files.outputs.file_count }}');
            if (fileCount > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚úÖ Automated workflow completed: ${fileCount} file(s) have been copied to the Working Folder.`
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `‚ÑπÔ∏è No files to copy to Working Folder in this PR.`
              });
            }
      
      - name: Auto-merge PR
        continue-on-error: true
        uses: actions/github-script@v6
        with:
          script: |
            try {
              // Close the PR since files have been copied to Working Folder
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                state: 'closed'
              });
              
              // Add a comment explaining the closure
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `üéâ Pull request automatically closed. All modified files have been copied to the Working Folder in the base branch.`
              });
              
              console.log(`PR #${context.issue.number} has been automatically closed`);
            } catch (error) {
              console.error('Error auto-closing PR:', error);
            }
